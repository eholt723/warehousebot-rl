<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WarehouseBot RL — Simulation</title>
  <meta name="description" content="Reinforcement-Learning Warehouse Bot Simulation by Eric Holt" />
  <link rel="icon" href="images/favicon.png" />
  <link rel="stylesheet" href="style.css" />

  <style>
    /* ==== Mobile adjustments ==== */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      #stage {
        width: 100%;
        height: 420px;
        max-height: 55vh;
        display: block;
        margin: 0 auto;
      }
      #rl-ui {
        position: static !important;
        right: auto !important;
        bottom: auto !important;
        width: auto;
        max-width: none;
        margin: 8px 12px 0 12px;
      }
      #rl-ui .rl-card-body { padding: 8px 10px; }
      #rl-log-stream { display: none !important; }
    }
  </style>
</head>

<body>
  <h1>WarehouseBot RL Simulation</h1>
  <main>
    <div id="instructions">Select shipment items and start the simulation.</div>

    <!-- ======= Desktop Controls ======= -->
    <section class="controls">
      <button id="selectAllBtn">Select All</button>
      <button id="clearAllBtn">Clear</button>
      <button id="submitItems">Update Shipment</button>
      <button id="startBtn">Start Simulation</button>
      <button id="resetBtn">Reset</button>
    </section>

    <!-- ======= Item Buttons ======= -->
    <section id="itemButtons" class="shipment-input"></section>

    <!-- ======= Map Canvas ======= -->
    <canvas id="stage" width="900" height="540"></canvas>

    <!-- ======= Stats Text ======= -->
    <div id="stats">Loading layout...</div>

    <div id="legend">
      <p>Green = drop | Cyan = dock | Gray = people | Blue = bot</p>
    </div>

    <footer>
      <p>Created by Eric Holt · <a href="https://github.com/eholt723/warehousebot-rl" target="_blank">GitHub Repo</a></p>
    </footer>
  </main>

  <!-- ======= Mobile Intro ======= -->
  <div id="mobileIntro" hidden>
    <div class="overlay">
      <h2>Quick Start</h2>
      <p>Tap anywhere to begin the warehouse simulation.</p>
    </div>
  </div>

  <!-- ======= Mobile Setup ======= -->
  <div id="mobileSetup" hidden>
    <div class="overlay">
      <h2>Select Items</h2>
      <div id="mobileItemButtons"></div>
      <div class="mobile-btns">
        <button id="mSelectAllBtn">Select All</button>
        <button id="mClearAllBtn">Clear</button>
        <button id="mSubmitItems">Update Shipment</button>
        <button id="mStartBtn">Start Simulation</button>
      </div>
    </div>
  </div>

  <!-- ======= RL UI Overlay ======= -->
  <div id="rl-ui" class="rl-card">
    <div class="rl-card-body">
      <h2>RL Training</h2>
      <div id="rl-episodes">Episode: <span id="rl-ep">0</span></div>
      <div id="rl-epsilon">Epsilon: <span id="rl-eps">1.00</span></div>
      <div id="rl-avg">Avg Reward: <span id="rl-avg-val">0</span></div>
      <div id="rl-steps">Steps / Run: <span id="rl-steps-val">0</span></div>
      <div id="rl-log-stream" class="rl-log"></div>
    </div>
  </div>

  <script>
    /* ======= RL UI Bootstrap ======= */
    (function () {
      const panel = document.getElementById("rl-ui");
      const ep = document.getElementById("rl-ep");
      const eps = document.getElementById("rl-eps");
      const avg = document.getElementById("rl-avg-val");
      const steps = document.getElementById("rl-steps-val");
      const logBox = document.getElementById("rl-log-stream");

      window.__WarehouseUI = {
        log(msg) {
          const line = document.createElement("div");
          line.textContent = msg;
          logBox?.appendChild(line);
          if (logBox) logBox.scrollTop = logBox.scrollHeight;
        },
        setEpisode(n) { ep.textContent = n; },
        setEpsilon(e) { eps.textContent = e.toFixed(2); },
        setLastSteps(s) { steps.textContent = s; },
        recordEpisodeReward(r) { avg.textContent = r.toFixed(1); },
        setRemoteTopline(avgVal, last3) {
          if (avgVal !== null) avg.textContent = avgVal.toFixed(1);
          if (last3?.length) steps.textContent = Math.round(last3.reduce((a,b)=>a+b,0)/last3.length);
        }
      };

      function place() {
        // ⬇️ Skip fixed positioning on mobile so it sits under the map
        if (window.matchMedia("(max-width: 768px)").matches) return;

        const legend = document.getElementById("legend");
        const h = legend ? legend.getBoundingClientRect().height : 160;
        panel.style.position = "fixed";
        panel.style.right = "16px";
        panel.style.bottom = (16 + h + 12) + "px";
        panel.style.width = "340px";
        panel.style.maxHeight = "58vh";
        panel.style.overflow = "hidden";
        panel.style.zIndex = "501";
      }
      place();
      window.addEventListener("resize", place);
    })();
  </script>

  <script src="app.js"></script>
</body>
</html>
