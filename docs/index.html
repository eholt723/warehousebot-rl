<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WarehouseBot-RL</title>
  <link rel="icon" type="image/png" href="./favicon.png" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Mobile + desktop layout tweaks -->
  <style>
    /* ===== Desktop Quick Start position (visible only on desktop) ===== */
    #instructions {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(16, 22, 51, 0.9);
      border: 1px solid #20285a;
      border-radius: 8px;
      padding: 10px 12px;
      color: #e8ecff;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
      z-index: 10;
    }
    #instructions h3 { margin: 0 0 6px; font-size: 14px; font-weight: 600; color: #b9c3ff; }
    #instructions ol { margin: 0; padding-left: 18px; }

    /* ===== Mobile-only adjustments ===== */
    @media (max-width: 768px) {
      /* Hide the huge title to free space on phones */
      main > h1 { display: none !important; }

      /* Hide desktop instructions bubble on phones */
      #instructions { display: none !important; }

      /* Canvas: shorter and responsive */
      #stage {
        width: 100%;
        height: 420px;       /* nice fit on most phones */
        max-height: 55vh;    /* never exceed 55% of viewport */
        display: block;
        margin: 8px auto 0;
      }

      /* RL panel: compact block directly under the canvas */
      #rl-ui {
        position: static !important;
        right: auto !important;
        bottom: auto !important;
        width: auto;
        max-width: none;
        margin: 8px 0 0 0;   /* butted right under the map */
      }
      #rl-ui .rl-card-body { padding: 8px 10px; }
      #rl-ui h3 { font-size: 16px; margin: 0 0 6px; }
      .rl-topline { font-size: 14px; line-height: 1.35; }

      /* Hide the verbose console on phones */
      #rl-log-stream { display: none !important; }
    }
  </style>
</head>

<body>
  <!-- Quick Start bubble (desktop only) -->
  <div id="instructions" aria-label="How to use">
    <h3>Quick Start:</h3>
    <ol>
      <li>Select items for the shipment (A–J)</li>
      <li>Click <strong>Update Shipment</strong>.</li>
      <li>Click <strong>Start Simulation</strong>.</li>
      <li>Keep your eye on the Blue Bot.</li>
    </ol>
  </div>

  <!-- Mobile Intro (tap anywhere) -->
  <div id="mobileIntro" hidden>
    <div class="mi-card" role="dialog" aria-label="Quick Start - Tap to continue">
      <h3>Quick Start</h3>
      <ol>
        <li>Select items (A–J)</li>
        <li>Tap <strong>Update Shipment</strong></li>
        <li>Tap <strong>Start Simulation</strong></li>
        <li>Watch the Blue Bot.</li>
      </ol>
      <p class="mi-hint">Tap anywhere to continue</p>
    </div>
  </div>

  <!-- Mobile Setup (item picker + start) -->
  <div id="mobileSetup" hidden>
    <div class="ms-card" role="dialog" aria-label="Setup Shipment">
      <h3>Set up your shipment</h3>

      <div class="ms-toolbar">
        <div class="ms-actions">
          <button id="mSelectAllBtn" type="button">Select All</button>
          <button id="mClearAllBtn" type="button">Clear</button>
          <button id="mSubmitItems" type="button" class="primary">Update Shipment</button>
        </div>
      </div>

      <div class="item-buttons" id="mobileItemButtons"><!-- built by JS --></div>

      <div class="ms-footer">
        <button id="mStartBtn" type="button" class="primary">Start Simulation</button>
      </div>
    </div>
  </div>

  <main>
    <h1>WarehouseBot-RL — Autonomous Picking Simulation</h1>

    <!-- Desktop toolbar (mobile flow hides these) -->
    <section class="shipment-input">
      <div class="shipment-toolbar">
        <div class="selector-actions">
          <button id="selectAllBtn" type="button">Select All</button>
          <button id="clearAllBtn" type="button">Clear</button>
          <button id="submitItems" type="button" class="primary">Update Shipment</button>
        </div>
        <div class="item-buttons" id="itemButtons"><!-- buttons added by JS --></div>
      </div>
    </section>

    <div class="controls">
      <button id="startBtn" type="button">Start Simulation</button>
      <button id="resetBtn" type="button">Reset</button>
      <span id="stats"></span>
    </div>

    <!-- Map -->
    <canvas id="stage" width="960" height="600" aria-label="Warehouse grid"></canvas>

    <!-- RL panel (desktop fixed; mobile flows under map) -->
    <section id="rl-ui" class="rl-card rl-fixed">
      <header class="rl-card-header">
        <h3>RL Training</h3>
      </header>
      <div id="rl-body" class="rl-card-body">
        <div id="rl-topline" class="rl-topline"></div>
        <div id="rl-log-stream" class="rl-log-stream" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <!-- Fixed legend -->
  <aside id="legend">
    <div class="row"><span class="k bot"></span> Bot</div>
    <div class="row"><span class="k item"></span> Stock Items</div>
    <div class="row"><span class="k picked"></span> Picked</div>
    <div class="row"><span class="k shelf"></span> Shelves / Obstacles</div>
    <div class="row"><span class="k person"></span> People (random walkers)</div>
    <div class="row"><span class="k drop"></span> Drop location (box)</div>
    <div class="row"><span class="k dock"></span> Docking station</div>
  </aside>

  <!-- RL UI bootstrap -->
  <script>
    (function () {
      const panel   = document.getElementById("rl-ui");
      const topline = document.getElementById("rl-topline");
      const logEl   = document.getElementById("rl-log-stream");

      const LS = {
        EPISODE: "whbot_episode",
        EPSILON: "whbot_epsilon",
        REWARD_HISTORY: "whbot_reward_history",
        STEPS_HISTORY: "whbot_steps_history"
      };
      const AVG_WINDOW = 100, MAX_POINTS = 1000;

      function loadArray(key){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return [];
          const a = JSON.parse(raw);
          return Array.isArray(a) ? a.map(Number).slice(-MAX_POINTS) : [];
        }catch{ return []; }
      }

      // persistent UI state
      let episode = parseInt(localStorage.getItem(LS.EPISODE) || "0", 10);
      let epsilon = parseFloat(localStorage.getItem(LS.EPSILON) || "1.0");
      let rewards = loadArray(LS.REWARD_HISTORY);
      let steps   = loadArray(LS.STEPS_HISTORY);

      function renderTopline(ep, rewardsArr, stepsArr, eps){
        const win = rewardsArr.slice(-AVG_WINDOW);
        const avg = win.length ? (win.reduce((a,b)=>a+b,0)/win.length) : 0;
        const avgStr = (avg>=0?"+":"")+avg.toFixed(1);

        const s = stepsArr.slice(-3);
        const improving = s.length===3 && s[0]>s[1] && s[1]>s[2];
        const trend = s.length ? s.join(", ") + (improving ? " (improving)" : "") : "—";
        const epsStr = Number.isFinite(eps)? eps.toFixed(2) : "1.00";

        topline.style.color = "#ff4d4d";
        topline.style.whiteSpace = "pre-wrap";
        topline.style.fontFamily = 'Consolas, "Courier New", ui-monospace, Menlo, monospace';
        topline.style.fontWeight = "normal";
        topline.style.border = "none";
        topline.style.background = "transparent";
        topline.style.padding = "0";

        let text =
          "Episode: " + ep + "\n" +
          "Avg Reward: " + avgStr + "\n" +
          "Steps per run: " + trend + "\n" +
          "Epsilon: " + epsStr;

        topline.textContent = text.replace(/\u2192|→/g, ", ");
      }

      // desktop placement above legend; mobile uses static flow via CSS
      function place(){
        if (window.matchMedia("(max-width: 768px)").matches) return;
        const legend = document.getElementById("legend");
        const h = legend ? legend.getBoundingClientRect().height : 160;
        panel.style.position = "fixed";
        panel.style.right = "16px";
        panel.style.bottom = (16 + h + 12) + "px";
        panel.style.width = "340px";
        panel.style.maxHeight = "58vh";
        panel.style.overflow = "hidden";
        panel.style.zIndex = "501";
      }
      place(); window.addEventListener("resize", place);

      // Expose UI API for app.js (keeps local state in sync)
      const api = {
        setEpisode(n){
          episode = n;
          try{ localStorage.setItem(LS.EPISODE, String(n)); }catch{}
          renderTopline(episode, rewards, steps, epsilon);
        },
        setEpsilon(eps){
          epsilon = eps;
          try{ localStorage.setItem(LS.EPSILON, String(eps)); }catch{}
          renderTopline(episode, rewards, steps, epsilon);
        },
        setLastSteps(){},
        recordEpisodeReward(r){
          rewards.push(Number(r));
          if (rewards.length > MAX_POINTS) rewards.splice(0, rewards.length - MAX_POINTS);
          try{ localStorage.setItem(LS.REWARD_HISTORY, JSON.stringify(rewards)); }catch{}
          renderTopline(episode, rewards, steps, epsilon);
        },
        addStepsLastRun(s){
          steps.push(Number(s));
          if (steps.length > MAX_POINTS) steps.splice(0, steps.length - MAX_POINTS);
          try{ localStorage.setItem(LS.STEPS_HISTORY, JSON.stringify(steps)); }catch{}
          renderTopline(episode, rewards, steps, epsilon);
        },
        log(msg){
          const ts = new Date().toLocaleTimeString();
          const div = document.createElement("div");
          div.className = "rl-log-line";
          div.textContent = `[${ts}] ${msg}`;
          logEl.appendChild(div);
          logEl.scrollTop = logEl.scrollHeight;
        }
      };
      window.__WarehouseUI = api;

      // initial paint
      renderTopline(episode, rewards, steps, epsilon);
      api.log("RL UI initialized.");
    })();
  </script>

  <!-- App -->
  <script src="app.js" defer></script>

  <!-- Signature -->
  <footer id="signature">Created by Eric Holt</footer>
</body>
</html>
