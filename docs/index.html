<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WarehouseBot-RL</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Hide any leftover map controls if older HTML is around */
    #mapSelect, #loadMapBtn, #mapStatus { display: none !important; }

    /* Simple instructions in the upper-left */
    #instructions {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(16, 22, 51, .9);
      border: 1px solid #20285a;
      border-radius: 8px;
      padding: 10px 12px;
      color: #e8ecff;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 320px;
      z-index: 10;
    }
    #instructions h3 { margin: 0 0 6px 0; font-size: 14px; font-weight: 600; color: #b9c3ff; }
    #instructions ol { margin: 0; padding-left: 18px; }
  </style>
</head>

<body>
  <div id="instructions" aria-label="How to use">
    <h3>Quick Start:</h3>
    <ol>
      <li>Select items for the shipment (A-J)</li>
      <li>Click <strong>Update Shipment</strong>.</li>
      <li>Click <strong>Start Simulation</strong>.</li>
      <li>Keep your eye on the Blue Bot.</li>
    </ol>
  </div>

  <main>
    <h1>WarehouseBot-RL â€” Autonomous Picking Simulation</h1>

    <section class="shipment-input">
      <div class="shipment-toolbar">
        <div class="selector-actions">
          <button id="selectAllBtn" type="button">Select All</button>
          <button id="clearAllBtn" type="button">Clear</button>
          <button id="submitItems" type="button" class="primary">Update Shipment</button>
        </div>

        <div class="item-buttons" id="itemButtons"><!-- buttons added by JS --></div>
      </div>
    </section>

    <div class="controls">
      <button id="startBtn" type="button">Start Simulation</button>
      <button id="resetBtn" type="button">Reset</button>
      <span id="stats"></span>
    </div>

    <canvas id="stage" width="960" height="600" aria-label="Warehouse grid"></canvas>
  </main>

  <!-- === RL Telemetry: compact panel, right side ABOVE legend === -->
  <section id="rl-ui" class="rl-card rl-fixed">
    <header class="rl-card-header">
      <h3>RL Training</h3>
    </header>

    <div id="rl-body" class="rl-card-body">
      <!-- Top row: PERSISTED metrics -->
      <div id="rl-topline" class="rl-topline"></div>

      <!-- Session-only console (clears on refresh) -->
      <div id="rl-log-stream" class="rl-log-stream" aria-live="polite"></div>
    </div>
  </section>

  <!-- Fixed legend bottom-right -->
  <aside id="legend">
    <div class="row"><span class="k bot"></span> Bot</div>
    <div class="row"><span class="k item"></span> Stock Items</div>
    <div class="row"><span class="k picked"></span> Picked</div>
    <div class="row"><span class="k shelf"></span> Shelves / Obstacles</div>
    <div class="row"><span class="k person"></span> People (random walkers)</div>
    <div class="row"><span class="k drop"></span> Drop location (box)</div>
    <div class="row"><span class="k dock"></span> Docking station</div>
  </aside>

  <!-- Inline UI bootstrap so it's guaranteed to exist before app.js -->
  <script>
  (function () {
    const LS = {
      EPISODE: "whbot_episode",
      EPSILON: "whbot_epsilon",
      REWARD_HISTORY: "whbot_reward_history",
      STEPS_HISTORY: "whbot_steps_history"
    };
    const AVG_WINDOW = 100, MAX_POINTS = 1000;

    const panel   = document.getElementById("rl-ui");
    const body    = document.getElementById("rl-body");
    const topline = document.getElementById("rl-topline");
    const logEl   = document.getElementById("rl-log-stream");

    function loadArray(key){
      try{ const raw = localStorage.getItem(key);
        if(!raw) return [];
        const a = JSON.parse(raw);
        return Array.isArray(a) ? a.map(Number).slice(-MAX_POINTS) : [];
      }catch{ return []; }
    }

    function renderTopline(ep, rewards, steps, eps){
      const win = rewards.slice(-AVG_WINDOW);
      const avg = win.length ? (win.reduce((a,b)=>a+b,0)/win.length) : 0;
      const avgStr = (avg>=0?"+":"")+avg.toFixed(1);

      const s = steps.slice(-3);
      const improving = s.length===3 && s[0]>s[1] && s[1]>s[2];

      // ðŸ”§ Use commas instead of arrows
      const trend = s.length ? s.join(", ") + (improving ? " (improving)" : "") : "â€”";
      const epsStr = Number.isFinite(eps)? eps.toFixed(2) : "1.00";

      // Make it red + multiline
      topline.style.color = "#ff4d4d";
      topline.style.whiteSpace = "pre-wrap";
      topline.style.fontFamily = 'Consolas, "Courier New", ui-monospace, Menlo, monospace';
      topline.style.fontWeight = "normal";
      topline.style.border = "none";
      topline.style.background = "transparent";
      topline.style.padding = "0";

      // Build text
      let text =
        "Episode: " + ep + "\n" +
        "Avg Reward: " + avgStr + "\n" +
        "Steps per run: " + trend + "\n" +
        "Epsilon: " + epsStr;

      // ðŸ›¡ï¸ Belt-and-suspenders: replace any arrows that slipped in
      text = text.replace(/\u2192|â†’/g, ", ");
      topline.textContent = text;
    }


    function note(text){
      const div = document.createElement("div");
      div.className = "rl-log-line rl-log-dim";
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    if (!panel || !body || !topline || !logEl){
      console.warn("[RL UI] required elements missing");
      return;
    }

    // persistent state
    let episode = parseInt(localStorage.getItem(LS.EPISODE) || "0", 10);
    let epsilon = parseFloat(localStorage.getItem(LS.EPSILON) || "1.0");
    let rewards = loadArray(LS.REWARD_HISTORY);
    let steps   = loadArray(LS.STEPS_HISTORY);

    // place panel above legend
    function place(){
      const legend = document.getElementById("legend");
      const h = legend ? legend.getBoundingClientRect().height : 160;
      panel.style.position = "fixed";
      panel.style.right = "16px";
      panel.style.bottom = (16 + h + 12) + "px";
      panel.style.width = "340px";
      panel.style.maxHeight = "58vh";
      panel.style.overflow = "hidden";
      panel.style.zIndex = "501";
    }
    place(); window.addEventListener("resize", place);

    // public API used by app.js
    const api = {
      setEpisode(n){ episode = n; try{localStorage.setItem(LS.EPISODE, String(n));}catch{} renderTopline(episode, rewards, steps, epsilon); },
      setEpsilon(eps){ epsilon = eps; try{localStorage.setItem(LS.EPSILON, String(eps));}catch{} renderTopline(episode, rewards, steps, epsilon); },
      setLastSteps(_s){ /* no-op for topline */ },
      recordEpisodeReward(r){
        rewards.push(Number(r));
        if (rewards.length > MAX_POINTS) rewards.splice(0, rewards.length - MAX_POINTS);
        try{ localStorage.setItem(LS.REWARD_HISTORY, JSON.stringify(rewards)); }catch{}
        renderTopline(episode, rewards, steps, epsilon);
      },
      addStepsLastRun(s){
        steps.push(Number(s));
        if (steps.length > MAX_POINTS) steps.splice(0, steps.length - MAX_POINTS);
        try{ localStorage.setItem(LS.STEPS_HISTORY, JSON.stringify(steps)); }catch{}
        renderTopline(episode, rewards, steps, epsilon);
      },
      log(msg){
        const ts = new Date().toLocaleTimeString();
        const div = document.createElement("div");
        div.className = "rl-log-line";
        div.textContent = `[${ts}] ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
      }
    };

    // expose immediately so app.js can use it
    window.__WarehouseUI = api;

    // first paint + self-test line so you SEE activity
    renderTopline(episode, rewards, steps, epsilon);
    api.log("RL UI initialized.");
  })();
  </script>

  <!-- Only your app.js now -->
  <script src="app.js" defer></script>

  <!-- Bottom-left signature -->
  <footer id="signature">Created by Eric Holt</footer>
</body>
</html>